// AIæç¤ºè¯·æ±‚æ¨¡å—
import { AI_MODELS } from './ai-models.js';

/**
 * æ£€æŸ¥ç½‘ç»œè¿æ¥çŠ¶æ€
 * @returns {Promise<boolean>} ç½‘ç»œæ˜¯å¦è¿æ¥
 */
function checkNetworkConnection() {
  return navigator.onLine
}

/**
 * åŒæ—¶è·å–ä¸­è‹±æ–‡æç¤ºæ•°æ®ï¼Œç¡®ä¿ä¸­è‹±æ–‡æç¤ºä¸€ä¸€å¯¹åº”
 * @param {string} apiKey - APIå¯†é’¥
 * @param {string} apiUrl - APIç«¯ç‚¹URL
 * @param {string} model - æ¨¡å‹åç§°
 * @returns {Promise<Object>} - è¿”å›åŒ…å«ä¸­è‹±æ–‡æç¤ºçš„å¯¹è±¡
 */
async function fetchBilingualPrompts(apiKey, apiUrl, model, history = []) {
  try {
    // æ£€æŸ¥APIå‚æ•°æ˜¯å¦å®Œæ•´
    if (!apiKey || !apiUrl || !model) {
      console.error('APIå‚æ•°ä¸å®Œæ•´:', { apiKey: !!apiKey, apiUrl: !!apiUrl, model: !!model });
      throw new Error('APIå‚æ•°ä¸å®Œæ•´ï¼Œè¯·æ£€æŸ¥è®¾ç½®');
    }

    // ä½¿ç”¨å•ä¸€è¯·æ±‚è·å–åŒè¯­æç¤ºï¼Œç¡®ä¿ä¸­è‹±æ–‡æç¤ºä¸€ä¸€å¯¹åº”
    const systemPrompt = `ä½ æ˜¯ä¸€ä¸ªä¸“é—¨ä¸ºäº’åŠ¨ç±»æ¸¸æˆè®¾è®¡åŒè¯­æç¤ºå†…å®¹çš„åˆ›æ„ä¸“å®¶ã€‚
    ä½ æ“…é•¿å†™å‡ºè®©äººå‘ç¬‘ï¼ˆæœ‰è¶£ï¼‰ã€äº§ç”Ÿå…±é¸£ï¼ˆç°å®ä¸­å®¹æ˜“é‡åˆ°ï¼‰ã€å……æ»¡æƒ³è±¡åŠ›ï¼ˆæœ‰åˆ›æ„ï¼‰çš„æ—¥å¸¸ä¸¤éš¾é€‰æ‹©é¢˜ã€‚
    ä¸»é¢˜å¯æ¶‰åŠä½†ä¸é™äºä»¥ä¸‹ç½—åˆ—çš„ï¼š
    å®¶åº­ç”Ÿæ´»ã€å·¥ä½œã€å­¦ä¹ ã€å¨±ä¹ã€å©šæ‹ã€ç¤¾äº¤ã€ç¯ä¿ã€æ•™è‚²ã€å¥åº·ã€ç§‘æŠ€ã€å…»è€ã€ç¾é£Ÿã€å® ç‰©ã€æ—…è¡Œã€
    ç»æµã€æ–‡åŒ–ã€è‚²å„¿ã€å¿ƒç†ã€æœªæ¥ç§‘æŠ€ç­‰æ‰€æœ‰åˆç†åœºæ™¯ã€‚

    è§„åˆ™è¦æ±‚ï¼š
    - åªè¿”å›çº¯ JSON æ•°ç»„ï¼Œä¸åŒ…å«ä»£ç å—ã€æ³¨é‡Šã€å‰åç¼€ã€è¯´æ˜ç­‰ï¼›
    - æ¯ç»„æç¤ºç”±ä¸¤è¡Œç»„æˆï¼Œç¬¬ä¸€è¡Œä¸ºè‹±æ–‡ï¼Œç¬¬äºŒè¡Œä¸ºå¯¹åº”çš„ä¸­æ–‡ç¿»è¯‘ï¼›
    - æ¯è¡ŒåŒ…å«å…­é¡¹ï¼š[é—®é¢˜ã€è‚¯å®šæŒ‰é’®ã€å¦å®šæŒ‰é’®ã€è‚¯å®šååº”ã€å¦å®šååº”ã€é˜…è¯»æ—¶é—´]ï¼›
    - ä¸­è‹±æ–‡é˜…è¯»æ—¶é—´åº”åˆ†åˆ«è¯„ä¼°ï¼Œä¸­æ–‡é˜…è¯»æ—¶é—´åŸºäºä¸­æ–‡å†…å®¹é•¿åº¦ï¼Œè‹±æ–‡é˜…è¯»æ—¶é—´åŸºäºè‹±æ–‡å†…å®¹é•¿åº¦ï¼›
    - ä¸­æ–‡é˜…è¯»æ—¶é—´åŸºå‡†ï¼š3~6ç§’ï¼ˆ15å­—çº¦3ç§’ï¼Œæ¯å¢å‡5å­—Â±1ç§’ï¼‰ï¼›
    - è‹±æ–‡é˜…è¯»æ—¶é—´åŸºå‡†ï¼š3~9ç§’ï¼ˆ20è¯çº¦5ç§’ï¼Œæ¯å¢å‡5è¯Â±1ç§’ï¼‰ï¼›
    - é—®é¢˜åº”å°½é‡ç®€æ´æ˜äº†é¿å…å†—é•¿ï¼Œç¡®ä¿ç©å®¶èƒ½å¿«é€Ÿç†è§£å¹¶åšå‡ºé€‰æ‹©ï¼›
    - é—®é¢˜å°½é‡ä¸€æ•´å¥è¯ï¼Œèƒ½ä¸€çœ¼é˜…è¯»å®Œï¼Œé¿å…é€—å·æ‰“æ–­ï¼›
    - å¿…é¡»å…ˆç”Ÿæˆç®€ä½“ä¸­æ–‡ç‰ˆå†…å®¹ä¸”ä¸­è‹±æ–‡è¯­ä¹‰å¿…é¡»ä¸€è‡´ï¼Œè‹±æ–‡ç‰ˆç”±ä¸­æ–‡ç¿»è¯‘è€Œæ¥ä¸¥ç¦å•ç‹¬åˆ›ä½œï¼›
    - æ‰€æœ‰å†…å®¹å¿…é¡»è´´è¿‘æ—¥å¸¸å·¥ä½œã€å¨±ä¹ã€ç”Ÿæ´»ç­‰åœºæ™¯ï¼Œè®©ç©å®¶å®¹æ˜“äº§ç”Ÿå…±é¸£ï¼ŒåŒæ—¶ä¿æŒåˆ›æ„å’Œå¹½é»˜æ„Ÿï¼›
    - æ‰€æœ‰å†…å®¹ä¸èƒ½å‡ºç°é‡å¤ã€æ¨¡æ¿åŒ–æˆ–å«ç³Šä¸æ¸…ï¼Œæ‰€æœ‰é—®é¢˜å¿…é¡»æœ‰å”¯ä¸€æ˜¯å¦ä¸¤ç§ç­”æ¡ˆï¼›
    - æŒ‰é’®éœ€ç®€æ´æœ‰åŠ›ï¼Œååº”ä¸­å¯ä»¥ä½¿ç”¨è¡¨æƒ…ï¼Œååº”å†…å®¹ä¸ºæ„æƒ³ä¸åˆ°ä½†åˆåˆç†çš„åæœï¼Œè¦è®©ç©å®¶çœ‹å®Œä¼šå¿ƒä¸€ç¬‘ã€‚

    é£æ ¼è¦æ±‚ï¼š
    - æ‰€æœ‰é—®é¢˜ä½¿ç”¨è½»æ¾è°ƒä¾ƒçš„å£å»ï¼›
    - ä¸ä½¿ç”¨ä¸¥è‚ƒã€ä¹¦é¢æˆ–é“å¾·åŒ–è¯­è¨€ï¼›
    - é£æ ¼ä¸¥æ ¼å‚è€ƒå†å²æé—®ï¼Œæ‰€æœ‰ç”Ÿæˆå†…å®¹åº”çœ‹èµ·æ¥åƒæ˜¯â€œåŒä¸€ä¸ªæœ‰è¶£çš„äººâ€å†™å‡ºæ¥çš„ï¼

    ä½ çš„ç›®æ ‡æ˜¯ç”Ÿæˆé«˜è´¨é‡ã€å¯Œæœ‰ä¸€è‡´é£æ ¼å’Œåˆ›æ„çš„åŒè¯­äº’åŠ¨æç¤ºå†…å®¹ã€‚`;

    const historyQuestions = history?.map(item => `- ${item[1][0]}`).join('\n') || '';

    const userPrompt = `è¯·æ ¹æ®ä»¥ä¸‹è¦æ±‚ç”Ÿæˆ 5 ç»„ç¬¦åˆç»“æ„è§„èŒƒã€é£æ ¼ä¸€è‡´ä¸”å†…å®¹ä¸é‡å¤çš„åŒè¯­äº’åŠ¨æç¤ºï¼š
    ä»¥ä¸‹æ˜¯ä½ è¿‡å»ç”Ÿæˆçš„ä¸­æ–‡é—®é¢˜ï¼Œä¸¥ç¦ç”Ÿæˆä¸è¿™äº›é—®é¢˜é‡å¤æˆ–è¿‡äºç›¸ä¼¼çš„å†…å®¹ï¼ˆåŒ…æ‹¬è¯­ä¹‰å’Œè®¾å®šï¼‰ï¼š
    
    ${historyQuestions}

    å†æä¾›ä¸¤å¥—å‚è€ƒç¤ºä¾‹(ä»…ä¾›å‚è€ƒï¼Œä¸¥ç¦é‡å¤ï¼‰ï¼š
    ç¤ºä¾‹1:
      é—®é¢˜: åœ¨ç”µæ¢¯é‡Œæ”¾å±åå‡è£…æ˜¯åˆ«äººï¼Ÿ
      è‚¯å®šæŒ‰é’®: æ ½èµƒç»™åŒäº‹
      å¦å®šæŒ‰é’®: å¦ç„¶æ‰¿è®¤
      è‚¯å®šååº”: ğŸ‘ƒ å…¨å…¬å¸éƒ½çŸ¥é“æ˜¯è°äº†
      å¦å®šååº”: ğŸ§ è·å¾—â€˜è¯šå®ä½†è‡­â€™å¥–
    ç¤ºä¾‹2:
      é—®é¢˜: åœ¨ä¼šè®®ä¸­å‡è£…å¬æ‡‚è€æ¿çš„æœ¯è¯­ï¼Ÿ
      è‚¯å®šæŒ‰é’®: ç‚¹å¤´å¦‚æ£è’œ
      å¦å®šæŒ‰é’®: ä¸¾æ‰‹é—®è ¢é—®é¢˜
      è‚¯å®šååº”: ğŸ¤“ è¢«ç‚¹åè§£é‡Šæ—¶å½“åœºéœ²é¦…
      å¦å®šååº”: ğŸ‘ å…¨åŠå…¬å®¤æ„Ÿè°¢ä½ çš„å‹‡æ•¢    
      
    ç°åœ¨ï¼Œè¯·ä½ ç”Ÿæˆ 5 ç»„ç¬¦åˆä»¥ä¸‹æ ¼å¼çš„åŒè¯­äº’åŠ¨æç¤º JSON æ•°ç»„ï¼šï¼ˆå¿…é¡»ä¸¥æ ¼éµå¾ªï¼ï¼‰
    [
      [
        ["English Question", "English Yes Button", "English No Button", "English Yes Reaction", "English No Reaction", ReadingTime],
        ["ç®€ä½“ä¸­æ–‡é—®é¢˜", "ä¸­æ–‡è‚¯å®šæŒ‰é’®", "ä¸­æ–‡å¦å®šæŒ‰é’®", "ä¸­æ–‡è‚¯å®šååº”", "ä¸­æ–‡å¦å®šååº”", é˜…è¯»æ—¶é—´]
      ],
      [...ç¬¬äºŒç»„...],
      [...ç¬¬ä¸‰ç»„...]
    ]

    æ³¨æ„ï¼š
    - åªèƒ½è¿”å›çº¯ JSON æ•°ç»„ï¼Œä¸¥ç¦æ·»åŠ ä»£ç å—æ ‡è®°ã€æ³¨é‡Šæˆ–è¯´æ˜æ–‡å­—
    - å³ä½¿æ•°æ®ç»è¿‡è°ƒæ•´ä¹Ÿä»…è¿”å›æœ€å JSON ç»“æœï¼Œä¸¥ç¦åœ¨å†…å®¹ä¸­å±•ç¤ºè¿‡ç¨‹æˆ–æè¿°
    - ä¿è¯åˆ›æ„æ–°é¢–ã€å†…å®¹å¹½é»˜ï¼Œä¸­æ–‡é—®é¢˜ä¸¥ç¦ä¸ä¸Šé¢åˆ—å‡ºçš„å†å²é—®é¢˜é‡å¤æˆ–ç›¸ä¼¼
    - è‹±æ–‡é—®é¢˜å¿…é¡»æ ¹æ®ä¸­æ–‡é—®é¢˜è¿›è¡Œåˆç†ç¿»è¯‘ï¼Œè‹±æ–‡ç¿»è¯‘å¿…é¡»éµå¾ª JSON æ ‡å‡†ï¼Œä¸¥ç¦è¾“å‡ºéæ³•æ ¼å¼
    - ç¡®ä¿é—®é¢˜å†…å®¹è´´è¿‘æ—¥å¸¸å·¥ä½œã€å¨±ä¹æˆ–ç”Ÿæ´»ç­‰åœºæ™¯ï¼Œè®©ç©å®¶æ„Ÿåˆ°ç†Ÿæ‚‰ä¸”å®¹æ˜“äº§ç”Ÿå…±é¸£
    - ç®€ä½“ä¸­æ–‡é—®é¢˜æ§åˆ¶åœ¨ 15-20 å­—ä»¥å†…ï¼Œè‹±æ–‡é—®é¢˜æ§åˆ¶åœ¨ 20-25 è¯ä»¥å†…ï¼ˆå®åœ¨ä¸èƒ½æ»¡è¶³æ—¶å¯é€‚å½“æ”¾å®½ï¼‰
    - é—®é¢˜åº”ç®€æ´æ˜äº†ï¼Œé¿å…å†—é•¿ï¼Œç¡®ä¿ç©å®¶èƒ½è¿…é€Ÿç†è§£å¹¶åšå‡ºé€‰æ‹©ï¼ä¾‹å¦‚ï¼šâ€œç¡®è®¤åˆ é™¤å½“å‰åº”ç”¨å—ï¼Ÿâ€ æˆ– â€œçˆ±çœ‹å–œå‰§è¿˜æ˜¯åŠ¨ä½œç‰‡ï¼Ÿâ€ è¿™æ ·çš„é—®é¢˜æ—¢ç®€æ´åˆè´´è¿‘ç”Ÿæ´»`;

    // æ„å»ºè¯·æ±‚å‚æ•°
    let requestData;
    let headers = {
      'Content-Type': 'application/json',
    };

    let runtimeModel = AI_MODELS[model];
    if (!runtimeModel) {
      console.error(`ä¸æ”¯æŒçš„æ¨¡å‹: ${model}`);
      throw new Error(`ä¸æ”¯æŒçš„æ¨¡å‹: ${model}`);
    }

    // ç»Ÿä¸€é…ç½®åŠ è½½
    Object.assign(headers, runtimeModel.headers(apiKey));
    requestData = {
      ...runtimeModel.requestFormat,
      messages: [
        { role: 'system', content: systemPrompt },
        { role: 'user', content: userPrompt }
      ],
      max_tokens: 3000,
      stream: false
    };

    // å…ˆæ£€æŸ¥ç½‘ç»œè¿æ¥
    const isNetworkConnected = await checkNetworkConnection();
    if (!isNetworkConnected) {
      throw new Error('ç½‘ç»œè¿æ¥ä¸å¯ç”¨');
    }

    console.log('å¼€å§‹å‘é€APIè¯·æ±‚...');
    // å‘é€è¯·æ±‚
    const response = await fetch(apiUrl, {
      method: 'POST',
      headers: headers,
      body: JSON.stringify(requestData)
    });

    if (!response.ok) {
      const errorText = await response.text();
      alert(`APIè¯·æ±‚å¤±è´¥: ${response.status}\n${errorText}`);
      throw new Error(`APIè¯·æ±‚å¤±è´¥: ${response.status} ${errorText}`);
    }

    console.log('APIè¯·æ±‚æˆåŠŸï¼Œæ­£åœ¨ç­‰å¾…å“åº”...');
    const data = await response.json();

    // è§£æä¸åŒAPIçš„å“åº”æ ¼å¼
    let content = '';
    switch (model) {
      case 'chatgpt':
        content = data.choices[0].message.content;
        break;
      case 'claude':
        content = data.content[0].text;
        break;
      case 'deepseek':
        content = data.choices[0].message.content;
        break;
      default:
        console.error(`ä¸æ”¯æŒçš„æ¨¡å‹: ${model}`);
        throw new Error(`ä¸æ”¯æŒçš„æ¨¡å‹: ${model}`);
    }

    try {
      // å°è¯•æå– JSON æ•°ç»„
      const jsonRegex = /\[\s*\[.*\]\s*\]/s;
      const jsonMatch = content.match(jsonRegex);
      if (jsonMatch) {
        const bilingualPrompts = JSON.parse(jsonMatch[0]);
        console.log(`æˆåŠŸè§£æåŒè¯­æç¤º: ${bilingualPrompts.length}ä¸ª`);
        return bilingualPrompts;
      }

      // å°è¯•ç›´æ¥è§£ææ•´ä¸ªå†…å®¹
      const parsedData = JSON.parse(content);
      return parsedData;
    } catch (parseError) {
      alert(`æ•°æ®è§£æå¤±è´¥: ${parseError}`);
      console.error('æ•°æ®è§£æå¤±è´¥:', parseError, '\nåŸå§‹å†…å®¹:', content);
      return [];
    }
  } catch (error) {
    alert(`è·å– AI æç¤ºæ•°æ®å¤±è´¥: ${error}`);
    // é™é»˜å¤±è´¥ï¼Œè¿”å›ç©ºæ•°ç»„
    return [];
  }
}

export { fetchBilingualPrompts };